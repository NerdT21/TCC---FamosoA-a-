DROP DATABASE FamosoAcaiDB;
CREATE DATABASE FamosoAcaiDB;
USE FamosoAcaiDB;

CREATE TABLE `tb_funcionario` (                     
	`id_funcionario` int NOT NULL AUTO_INCREMENT,
	`id_depto` int NOT NULL,
	`nm_nome` varchar(50) NOT NULL,
	`ds_email` varchar(250) NOT NULL UNIQUE,
	`ds_cpf` varchar(50) NOT NULL UNIQUE,
	`ds_rg` varchar(50) NOT NULL,
	`dt_nascimento` varchar(10) NOT NULL,
	`ds_cidade` varchar(60) NOT NULL,
	`id_estado` int NOT NULL,
	`ds_cep` varchar(10) NOT NULL,
	`ds_telefone` varchar(20) NOT NULL,
	`ds_bairro` varchar(60) NOT NULL,
	`ds_rua` varchar(200) NOT NULL, 
	`img_funcionario` longblob NOT NULL, 
    `ds_complemento` varchar(500),
    `vl_salario` decimal NOT NULL,  
	PRIMARY KEY (`id_funcionario`)
);
--  drop table tb_funcionario;

CREATE TABLE `tb_depto` (
	`id_depto` int NOT NULL AUTO_INCREMENT,
	`nm_depto` varchar(100) NOT NULL,
	`ds_depto` varchar(500) NOT NULL,
	PRIMARY KEY (`id_depto`)
);

CREATE TABLE `tb_fornecedor` (
	`id_fornecedor` int NOT NULL AUTO_INCREMENT,
	`id_estado` int NOT NULL,
	`ds_cnpj` varchar(50) NOT NULL UNIQUE,
	`nm_fornecedor` varchar(150) NOT NULL,
	`ds_cep` varchar(12) NOT NULL,
	`ds_rua` varchar(200) not null,
    `ds_cidade` varchar(60) NOT NULL,
	`ds_telefone` varchar(24) NOT NULL,
	`ds_email` varchar(120) NOT NULL UNIQUE, --
	PRIMARY KEY (`id_fornecedor`)
);
-- drop table tb_fornecedor;

CREATE TABLE `tb_produto` (
	`id_produto` int NOT NULL AUTO_INCREMENT,
	`nm_nome` varchar(150) NOT NULL,
	`vl_preco` DECIMAL(12,2) NOT NULL,
	`ds_descricao` varchar(255),
	PRIMARY KEY (`id_produto`)
);

CREATE TABLE `tb_login` (
	`id_usuario` int NOT NULL AUTO_INCREMENT,
    `nm_funcionario` varchar(50) NOT NULL,
	`nm_usuario` varchar(50) NOT NULL UNIQUE,
	`ds_senha` varchar(20) NOT NULL,
    `ds_email` varchar(150) NOT NULL,
	`pr_permissaoADM` bool NOT NULL,
    `pr_permissaoCaixa` bool NOT NULL,
    `pr_permissaoFinanceiro` bool NOT NULL,
    `pr_permissaoEstoque` bool NOT NULL,
    `pr_permissaoCadastros` bool NOT NULL,
	PRIMARY KEY (`id_usuario`)
);

CREATE TABLE `tb_estoque` (
	`id_estoque` int NOT NULL AUTO_INCREMENT,
    `id_itemProduto` int NOT NULL,
	`nm_produto` varchar(250) NOT NULL,
	`qtd_estocado` bigint NOT NULL,
	PRIMARY KEY (`id_estoque`)
);



CREATE TABLE `tb_compra` (
	`id_compra` int NOT NULL AUTO_INCREMENT,
    `id_usuario` int NOT NULL,
	`dt_compra` varchar(10) NOT NULL,
	`ds_formaPagamento` varchar(50) NOT NULL,
	PRIMARY KEY (`id_compra`),
    FOREIGN KEY(`id_usuario`)
    REFERENCES tb_login(`id_usuario`)
);

CREATE TABLE `tb_venda` (
	`id_venda` int NOT NULL AUTO_INCREMENT,
	`id_usuario` int NOT NULL,
	`dt_venda` varchar(15)NOT NULL,
	`ds_formaPagamento` varchar (50) NOT NULL,
     PRIMARY KEY (`id_venda`),
     FOREIGN KEY (`id_usuario`)
     REFERENCES  tb_login(`id_usuario`)
);

CREATE TABLE `tb_produtoVenda` (
	`id_produtoVenda` int NOT NULL AUTO_INCREMENT,
	`id_produto` int NOT NULL,
	`id_venda` int NOT NULL,
	PRIMARY KEY (`id_produtoVenda`)
);

CREATE TABLE `tb_folhaDePagamento` (
	`id_folhaPagto` int NOT NULL AUTO_INCREMENT,
	`ds_horasExtras` varchar(10) NOT NULL,
	`int_faltas` int NOT NULL,
	`vl_salarioBruto` DECIMAL(15,2) NOT NULL,
	`vl_impostoDeRenda` DECIMAL(15,2) NOT NULL,
	`vl_ftgs` DECIMAL(15,2) NOT NULL,
	`vl_valeTransporte` DECIMAL(15,2) NOT NULL,
	`id_funcionario` int NOT NULL,
	`vl_salarioLiq` DECIMAL(15,2) NOT NULL,
	`vl_inss` decimal(15,2) NOT NULL,
	`vl_salFamilia` decimal(15,2) NOT NULL,
    `dt_pagamento` varchar(10) NOT NULL,
	PRIMARY KEY (`id_folhaPagto`),
    FOREIGN KEY(`id_funcionario`)
    REFERENCES tb_funcionario(`id_foncionario`)
);

CREATE TABLE `tb_inss` (
	`id_inss` int NOT NULL AUTO_INCREMENT,
	`ds_salarioDeContribuicao` decimal(15,2) NOT NULL,
	`vl_aliquota` DECIMAL(4,2) NOT NULL,
	PRIMARY KEY (`id_inss`)
);

CREATE TABLE `tb_impostoDeRenda` (
	`id_impostoRenda` int NOT NULL AUTO_INCREMENT,
    `ds_baseDeCalculo` decimal(15,2) NOT NULL,
	`vl_aliquota` DECIMAL(4,2) NOT NULL,
	`vl_deducao` DECIMAL(15,2) NOT NULL,
	PRIMARY KEY (`id_impostoRenda`)
);

CREATE TABLE `tb_salarioFamilia` (
	`id_salFamilia` int NOT NULL AUTO_INCREMENT,
	`ds_salFamilia` DECIMAL(15,2) NOT NULL,
    `vl_salFamilia` Decimal(15,2) NOT NULL,
	PRIMARY KEY (`id_salFamilia`)
);

CREATE TABLE `tb_item` (
	`id_item` int NOT NULL AUTO_INCREMENT,
	`id_fornecedor` int NOT NULL,
	`nm_item` varchar(50) NOT NULL,
	`ds_item` varchar(200) NOT NULL,
    `vl_preco` decimal (15,2) NOT NULL,
	PRIMARY KEY (`id_item`)
);

CREATE TABLE `tb_estados` (
	`id_estado` int NOT NULL AUTO_INCREMENT,
	`nm_estado` varchar(2) NOT NULL,
	PRIMARY KEY (`id_estado`)
);

CREATE TABLE `tb_gastosAdicionais` (
	`id_gasto` int NOT NULL AUTO_INCREMENT,
	`nm_gasto` varchar(25) NOT NULL,
	`ds_gasto` varchar(500) NOT NULL,
	`dt_gasto` varchar(15) NOT NULL, 
	`vl_gasto` DECIMAL(10,2) NOT NULL,
	PRIMARY KEY (`id_gasto`)
);
-- drop table tb_gastosAdicionais;

CREATE TABLE `tb_item_compra`(
`id_itemCompra` INT NOT NULL AUTO_INCREMENT,
`id_item` INT NOT NULL,
`id_compra` INT NOT NULL,
PRIMARY KEY(`id_itemCompra`),
FOREIGN KEY(`id_item`)
REFERENCES tb_item (`id_item`),
FOREIGN KEY(`id_compra`)
REFERENCES tb_compra(`id_compra`)
);
-- Drop table tb_item_compra;




ALTER TABLE `tb_funcionario` ADD CONSTRAINT `tb_funcionario_fk1` FOREIGN KEY (`id_depto`) REFERENCES `tb_depto`(`id_depto`);

ALTER TABLE `tb_funcionario` ADD CONSTRAINT `tb_funcionario_fk0` FOREIGN KEY (`id_estado`) REFERENCES `tb_estados`(`id_estado`);

ALTER TABLE `tb_fornecedor` ADD CONSTRAINT `tb_fornecedor_fk0` FOREIGN KEY (`id_estado`) REFERENCES `tb_estados`(`id_estado`);

-- ALTER TABLE `tb_estoque` ADD CONSTRAINT `tb_estoque_fk0` FOREIGN KEY (`id_compra`) REFERENCES `tb_compra`(`id_compra`);

-- ALTER TABLE `tb_compra` ADD CONSTRAINT `tb_compra_fk0` FOREIGN KEY (`id_item`) REFERENCES `tb_item`(`id_item`);

-- ALTER TABLE `tb_compra` ADD CONSTRAINT `tb_compra_fk1` FOREIGN KEY (`id_fornecedor`) REFERENCES `tb_fornecedor`(`id_fornecedor`);

ALTER TABLE `tb_produtoVenda` ADD CONSTRAINT `tb_produto_venda_fk0` FOREIGN KEY (`id_produto`) REFERENCES `tb_produto`(`id_produto`);

ALTER TABLE `tb_produtoVenda` ADD CONSTRAINT `tb_produto_venda_fk1` FOREIGN KEY (`id_venda`) REFERENCES `tb_venda`(`id_venda`);



INSERT INTO tb_depto(`id_depto`,`nm_depto`,`ds_depto`)
	 VALUES ('1','Gerência','Responsável por gerenciar e monitorar as outras áreas.');

              
 INSERT INTO tb_login(`id_usuario`, `nm_funcionario`, `nm_usuario`, `ds_senha`,`ds_email`, `pr_permissaoAdm`, `pr_permissaoCaixa`, `pr_permissaoFinanceiro`, `pr_permissaoEstoque`, `pr_permissaoCadastros`)
		      VALUES('1', 'NerdTeen', 'NerdT','NerdT2018', 'nerdt21@gmai.com', '1', '1', '1', '1', '1');             
              

INSERT INTO tb_inss(`id_inss`, `ds_salarioDeContribuicao`, `vl_aliquota`)
			VALUES('1', '1659.38', '8');
            
INSERT INTO tb_inss(`id_inss`, `ds_salarioDeContribuicao`, `vl_aliquota`)
			VALUES('2', '2765.66', '9');
            
INSERT INTO tb_inss(`id_inss`, `ds_salarioDeContribuicao`, `vl_aliquota`)
			VALUES('3', '5531.31', '11');
                        
              
INSERT INTO tb_salarioFamilia(`id_salFamilia`, `ds_salFamilia`, `vl_salFamilia`)
				   VALUES('1', '859.88', '44.00');
                   
INSERT INTO tb_salarioFamilia(`id_salFamilia`, `ds_salFamilia`, `vl_salFamilia`)
				   VALUES('2', '1292.43', '31.07');
                   
INSERT INTO tb_salarioFamilia(`id_salFamilia`, `ds_salFamilia`, `vl_salFamilia`)
				   VALUES('3', '1292.44', '0');
                

INSERT INTO tb_impostoDeRenda(`id_impostoRenda`, `ds_baseDeCalculo`, `vl_aliquota`, `vl_deducao`)
					   VALUES('1', '1903.98', '0', '0');
                       
INSERT INTO tb_impostoDeRenda(`id_impostoRenda`, `ds_baseDeCalculo`, `vl_aliquota`, `vl_deducao`)
					   VALUES('2', '1903.99', '7.5', '142.80');
                       
INSERT INTO tb_impostoDeRenda(`id_impostoRenda`, `ds_baseDeCalculo`, `vl_aliquota`, `vl_deducao`)
					   VALUES('3', '2826.66', '15', '354.80');
                       
INSERT INTO tb_impostoDeRenda(`id_impostoRenda`, `ds_baseDeCalculo`, `vl_aliquota`, `vl_deducao`)
					   VALUES('4', '3751.06', '22.5', '636.13');
                       
INSERT INTO tb_impostoDeRenda(`id_impostoRenda`, `ds_baseDeCalculo`, `vl_aliquota`, `vl_deducao`)
					   VALUES('5', '4664.68', '27.5', '869.36');
					


INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('1', 'AC');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('2','AL');     
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('3','AP');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('4','AM');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('5','BA');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('6','CE');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('7','DF');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('8','ES');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('9','GO');
                		
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('10','MA');                
		
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('11','MT');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('12','MS');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('13','MG');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('14','PA');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('15','PB');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('16','PR');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('17','PE');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('18','PI');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('19','RJ');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('20','RN');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('21','RS');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('22','RO');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('23','RR');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('24','SC');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('25','SP');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('26','SE');
                
INSERT INTO tb_estados(`id_estado`,`nm_estado`)
				VALUES('27','TO');

-- ================= --
-- ===== VIEWS ===== --
-- ================= --

-- DROP VIEW vw_estoque; 
CREATE VIEW  vw_estoque AS 
      SELECT tb_estoque.id_estoque,
             tb_item_compra.id_item,
             tb_estoque.nm_produto,
        sum( tb_item_compra.id_item) as qtd_estocado  
        FROM tb_estoque
        JOIN tb_item_compra
          ON tb_estoque.id_itemProduto = tb_item_compra.id_itemCompra
        GROUP 
        BY  tb_estoque.id_estoque;
        
        
-- DROP VIEW vw_consultar_venda;        
CREATE VIEW vw_consultar_venda AS
      SELECT tb_venda.id_venda,
             tb_venda.dt_venda,
             tb_venda.ds_formaPagamento,
             COUNT(tb_produtoVenda.id_produtoVenda) AS qtd_item,
             SUM(tb_produto.vl_preco) AS vl_total
FROM tb_venda
JOIN tb_produtoVenda
  ON tb_venda.id_venda = tb_produtoVenda.id_produtoVenda
JOIN tb_produto
  ON tb_produtoVenda.id_produtoVenda = tb_produto.id_produto 
GROUP
BY tb_venda.id_venda,
   tb_venda.dt_venda;
   
   
-- drop view vw_compra_consultar; 
 create view vw_consulta_Compra as
 select  tb_compra.id_compra,
         tb_compra.ds_formaPagamento,
         tb_compra.dt_compra,
count(tb_item_Compra.id_itemCompra) as qtd_item,
sum(tb_item.vl_preco) as  vl_total  
from tb_compra
join tb_item_compra
on tb_compra.id_compra = tb_item_compra.id_compra
join tb_item
   on tb_item_compra.id_item = tb_item_compra.id_compra
group by
            tb_compra.id_compra,
            tb_compra.ds_formaPagamento,
            tb_compra.dt_compra;
            
            

-- Drop view vw_consultarFuncionario; 
CREATE VIEW vw_consultarFuncionario AS
	SELECT tb_funcionario.id_funcionario,
		   tb_funcionario.vl_salario,
           tb_Depto.nm_depto,
           tb_funcionario.nm_nome,
           tb_funcionario.ds_email,
           tb_funcionario.ds_cpf,
           tb_funcionario.ds_rg,
           tb_estados.nm_estado,
           tb_funcionario.ds_cidade,
		   tb_funcionario.ds_cep,
           tb_funcionario.ds_rua, 
           tb_funcionario.ds_bairro, 
           tb_funcionario.ds_complemento,
           tb_funcionario.ds_telefone,
           tb_funcionario.img_funcionario 
	FROM tb_funcionario
    JOIN tb_estados
    ON tb_funcionario.id_estado = tb_estados.id_estado
    JOIN tb_Depto
    ON tb_funcionario.id_depto = tb_Depto.id_depto;


-- drop view vw_consultarFornecedor;     
CREATE VIEW vw_consultarFornecedor AS
	SELECT tb_fornecedor.id_fornecedor,
		   tb_fornecedor.nm_fornecedor,
           tb_fornecedor.ds_cnpj,
           tb_fornecedor.ds_email,
           tb_fornecedor.ds_telefone,
           tb_fornecedor.ds_cidade,
           tb_estados.nm_estado,
           tb_fornecedor.ds_cep,
           tb_fornecedor.ds_rua
	FROM tb_fornecedor
    JOIN tb_estados
      ON tb_fornecedor.id_estado = tb_estados.id_estado;
      

-- drop view vl_item;
CREATE VIEW vw_item AS
	SELECT tb_item.id_item,
           tb_item.nm_item, 
           tb_fornecedor.nm_fornecedor,
           tb_item.ds_item,
           tb_item.vl_preco
	FROM tb_item
    JOIN tb_fornecedor
      ON tb_item.id_fornecedor = tb_fornecedor.id_fornecedor;    
    
  
          
 
 /*
-- ========================= --
-- ===== SELECT TABELAS===== --
-- ========================= --
 
SELECT * FROM tb_login;
SELECT * FROM tb_depto;
SELECT * FROM tb_estados;
SELECT * FROM tb_fornecedor;
SELECT * FROM tb_estoque;
SELECT * FROM tb_item_compra;


-- ======================= --
-- ===== SELECT VIEWs===== --
-- ======================= --

SELECT * FROM vw_estoque;
SELECT * FROM vw_consultar_venda;
SELECT * FROM vw_consulta_Compra;
SELECT * FROM vw_item; 
SELECT * FROM vw_consultarFornecedor;
SELECT * FROM vw_consultarFuncionario;
